name: Split & Validate Rules

on:
  schedule:
    - cron: "0 0 * * *"       # æ¯å¤©å¼ºåˆ¶æ›´æ–°
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Git Config
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Force refresh urls.txt
        run: |
          echo "âœ… å¼ºåˆ¶åˆ·æ–° urls.txt"
cat > urls.txt << 'EOF'
https://raw.githubusercontent.com/wxglenovo/AdGuardHome-Filter/refs/heads/main/AdGuard%20Home_Allowlist.txt
https://raw.githubusercontent.com/wxglenovo/AdGuardHome-Filter/refs/heads/main/AdGuard%20Home_Blacklist.txt
https://raw.githubusercontent.com/217heidai/adblockfilters/main/rules/adblockdnslite.txt
https://gh-proxy.com/raw.githubusercontent.com/changzhaoCZ/fqnovel-adrules/refs/heads/main/fqnovel-fxxk_ads
https://anti-ad.net/easylist.txt
EOF

      - name: Install Python deps
        run: |
          pip install requests dnspython

      - name: Prepare fast validation script
        run: |
          cat > fast_validate.py << 'EOF'
#!/usr/bin/env python3
import concurrent.futures
import dns.resolver
import re
import sys

input_file = sys.argv[1]
output_file = sys.argv[2]

resolver = dns.resolver.Resolver()
resolver.timeout = 1
resolver.lifetime = 1

domain_regex = re.compile(
    r"^(?!-)([A-Za-z0-9-]{1,63}\.)+[A-Za-z]{2,}$"
)

def extract_domain(rule):
    rule = rule.strip().lstrip("|").lstrip("@@").replace("||", "").split("^")[0]
    rule = rule.replace("*", "")
    return rule

def is_valid(rule):
    domain = extract_domain(rule)
    if not domain or not domain_regex.match(domain):
        return False
    try:
        resolver.resolve(domain, "A")
        return True
    except dns.resolver.NXDOMAIN:
        return False
    except:
        return True

with open(input_file, "r", encoding="utf-8") as f:
    rules = [line.strip() for line in f if line.strip()]

valid_rules = []

with concurrent.futures.ThreadPoolExecutor(max_workers=200) as executor:
    results = executor.map(is_valid, rules)

for rule, ok in zip(rules, results):
    if ok:
        valid_rules.append(rule)

with open(output_file, "w", encoding="utf-8") as f:
    f.write("\n".join(valid_rules))

print(f"âœ… {input_file} â†’ {output_file}")
print(f"âœ… æ€»: {len(rules)}, æœ‰æ•ˆ: {len(valid_rules)}, åˆ é™¤: {len(rules)-len(valid_rules)}")
EOF

      - name: Download & Merge all rules
        run: |
          mkdir -p tmp dist
          echo "ğŸ“¥ å¼€å§‹ä¸‹è½½æ‰€æœ‰è§„åˆ™æº"
cat > merge.py << 'EOF'
import requests, os

with open("urls.txt") as f:
    urls = [x.strip() for x in f if x.strip()]

all_rules = set()
os.makedirs("tmp", exist_ok=True)

for url in urls:
    print("Downloading:", url)
    try:
        r = requests.get(url, timeout=30)
        if r.status_code == 200:
            for line in r.text.splitlines():
                line = line.strip()
                if line and not line.startswith("#"):
                    all_rules.add(line)
    except Exception as e:
        print("âŒ Failed:", e)

with open("tmp/merged.txt", "w", encoding="utf-8") as f:
    for r in sorted(all_rules):
        f.write(r + "\n")

print("âœ… åˆå¹¶å®Œæˆè§„åˆ™:", len(all_rules))
EOF
          python3 merge.py

      - name: Split Rules
        run: |
          echo "âœ‚ åˆ†ç‰‡ä¸­..."
          rm -f tmp/part_*.txt
          split -l 60000 tmp/merged.txt tmp/part_
          for f in tmp/part_*; do mv "$f" "$f.txt"; done

          COUNT=$(ls tmp/part_*.txt | wc -l)
          echo "âœ… åˆ†ç‰‡æ•°é‡: $COUNT"

      - name: Fast Validate all parts
        run: |
          rm -f dist/validated_part_*.txt
          for f in tmp/part_*.txt; do
            out="dist/validated_$(basename "$f")"
            echo "âš¡ æé€ŸéªŒè¯ $f"
            python3 fast_validate.py "$f" "$out"
          done

      - name: Merge final rules
        run: |
          echo "âœ… åˆå¹¶éªŒè¯å®Œæˆåˆ†ç‰‡ â†’ dist/final_rules.txt"
          cat dist/validated_part_*.txt > dist/final_rules.txt
          wc -l dist/final_rules.txt

      - name: Commit & Push
        run: |
          git add urls.txt dist/*.txt || true
          git commit -m "âœ… è‡ªåŠ¨æ›´æ–°è§„åˆ™ $(date '+%Y-%m-%d %H:%M:%S')" || echo "âš  æ— éœ€æäº¤"
          git push || echo "âš  Push å¤±è´¥"
