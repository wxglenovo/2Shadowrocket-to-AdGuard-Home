name: Split & DNS Check

on:
  schedule:
    # æ¯å¤© UTC 0:00ã€6:00ã€12:00ã€18:00 å¼ºåˆ¶æ›´æ–°å¹¶åˆ‡ç‰‡
    - cron: "0 0 * * *"
    - cron: "0 6 * * *"
    - cron: "0 12 * * *"
    - cron: "0 18 * * *"

    # æ¯ 22 åˆ†é’Ÿè½®æ›¿åˆ†ç‰‡éªŒè¯
    - cron: "*/22 * * * *"

  workflow_dispatch:
    inputs:
      part:
        description: 'æ‰‹åŠ¨éªŒè¯æŒ‡å®šåˆ†ç‰‡ 1~16'
        required: false
        default: ''

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install python deps
        run: |
          pip install requests dnspython

      # -----------------------------------
      # ä¸‹è½½ URLs & åˆå¹¶è§„åˆ™ & åˆ‡ç‰‡
      # ä»…åœ¨æ•´ç‚¹ 0/6/12/18 æ‰§è¡Œ
      # -----------------------------------
      - name: Download & Merge & Split
        if: startsWith(github.event.schedule, '0 ')
        run: |
          mkdir -p tmp dist logs

          echo "ğŸ“¥ ä¸‹è½½æºåˆ—è¡¨ urls.txt ..."
          python download_merge_split.py

          echo "âœ… åˆ‡ç‰‡å®Œæˆ"

      # -----------------------------------
      # è‡ªåŠ¨é€‰æ‹©åˆ†ç‰‡ç¼–å·ï¼ˆè½®æ›¿æ¨¡å¼ï¼‰
      # github.run_number % 16 â†’ å¾—åˆ° 1~16
      # -----------------------------------
      - name: Determine shard index
        id: shard
        run: |
          PART=${{ github.event.inputs.part }}
          if [ -z "$PART" ]; then
            idx=$(( ($GITHUB_RUN_NUMBER % 16) + 1 ))
          else
            idx=$PART
          fi
          echo "shard=$idx" >> $GITHUB_OUTPUT
          echo "å½“å‰éªŒè¯åˆ†ç‰‡ï¼š$idx"

      # -----------------------------------
      # éªŒè¯åˆ†ç‰‡ - ä¼ å…¥ 3 ä¸ªå‚æ•°
      # validate.py <part> <validated> <log>
      # -----------------------------------
      - name: Validate shard
        run: |
          mkdir -p logs dist tmp

          P=${{ steps.shard.outputs.shard }}
          PART_FILE="tmp/part_${P}.txt"
          OUT_FILE="dist/validated_part_${P}.txt"
          LOG_FILE="logs/part_${P}.log"

          echo "â± å¼€å§‹éªŒè¯åˆ†ç‰‡ $P"
          python validate.py "$PART_FILE" "$OUT_FILE" "$LOG_FILE"

      # -----------------------------------
      # æäº¤ç»“æœ
      # -----------------------------------
      - name: Commit & Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add dist logs || exit 0
          git commit -m "âœ… åˆ†ç‰‡éªŒè¯å®Œæˆ: part_${{ steps.shard.outputs.shard }}" || exit 0
          git push
