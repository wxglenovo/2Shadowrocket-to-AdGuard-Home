name: Split & DNS Check

on:
  schedule:
    - cron: "0 0 * * *"
    - cron: "0 6 * * *"
    - cron: "0 12 * * *"
    - cron: "0 18 * * *"
    - cron: "*/22 * * * *"
  workflow_dispatch:
    inputs:
      part:
        description: '手动验证指定分片 1~16'
        required: false
        default: ''

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: 安装依赖
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-dnspython

    - name: 初始化目录
      run: |
        mkdir -p dist
        mkdir -p tmp

    - name: 如果需要手动验证指定分片
      if: ${{ inputs.part != '' }}
      run: |
        echo "⚙ 手动验证分片 ${{ inputs.part }}"
        python3 split_and_check_16.py ${{ inputs.part }}

    - name: 自动验证全部分片
      if: ${{ inputs.part == '' }}
      run: |
        echo "⚙ 自动验证所有分片"
        for i in $(seq -f "%02g" 1 16)
        do
          if [ -f "tmp/part_${i}.txt" ]; then
            echo "✅ 验证 part ${i}"
            python3 split_and_check_16.py ${i}
          else
            echo "⚠ 跳过分片 ${i}（文件不存在）"
          fi
        done

    - name: 推送结果
      run: |
        git config --local user.email "actions@github.com"
        git config --local user.name "GitHub Actions"

        git add .
        if git commit -m "✅ Update validated parts & not_written_counter.json"; then
          git push
        else
          echo "⚠ 无变化，不推送"
        fi
