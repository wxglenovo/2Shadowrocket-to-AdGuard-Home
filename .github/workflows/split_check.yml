name: Split & DNS Check

on:
  schedule:
    # 每天 UTC 0:00、6:00、12:00、18:00 强制更新 urls.txt 并生成分片
    - cron: "0 0 * * *"
    - cron: "0 6 * * *"
    - cron: "0 12 * * *"
    - cron: "0 18 * * *"
    # 每 22 分钟轮替分片验证
    - cron: "*/22 * * * *"

  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      PYTHONUNBUFFERED: 1

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.12

      - name: Install dependencies
        run: pip install dnspython requests

      - name: Create directories
        run: mkdir -p tmp dist logs

      - name: Determine current part
        id: part
        run: |
          TOTAL=16
          CURRENT_HOUR=$(date -u +"%H")
          CURRENT_MIN=$(date -u +"%M")
          # 计算分片编号轮替
          PART=$(( (10#$CURRENT_HOUR*60 + 10#$CURRENT_MIN)/22 % TOTAL + 1 ))
          echo "PART=$PART" >> $GITHUB_ENV

      - name: Run validation
        run: |
          PART_FILE=$(printf "tmp/part_%02d.txt" "$PART")
          VALIDATED_FILE=$(printf "dist/validated_part_%02d.txt" "$PART")
          LOG_FILE=$(printf "logs/split_check_part_%02d.log" "$PART")
          python validate.py "$PART_FILE" "$VALIDATED_FILE" "$LOG_FILE"
          cat "$LOG_FILE"

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add dist tmp logs
          git commit -m "Auto update part $PART [skip ci]" || echo "No changes to commit"
          git push
