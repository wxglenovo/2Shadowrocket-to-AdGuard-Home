name: Validate AdGuard Rules (16-way Parallel)

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          pip install requests dnspython

      - name: Download & Merge Rules
        run: |
          python3 << 'EOF'
import os, requests

URLS = "urls.txt"
MASTER = "merged_rules.txt"

if not os.path.exists(URLS):
    print("âŒ urls.txt ä¸å­˜åœ¨ï¼Œç»ˆæ­¢")
    exit(1)

merged = set()
for u in open(URLS, "r", encoding="utf-8"):
    u = u.strip()
    if not u: continue
    print("ğŸŒ ä¸‹è½½", u)
    try:
        r = requests.get(u, timeout=20)
        r.raise_for_status()
        for line in r.text.splitlines():
            line=line.strip()
            if line and not line.startswith("#"):
                merged.add(line)
    except Exception as e:
        print("âš  ä¸‹è½½å¤±è´¥", u, e)

print("âœ… åˆå¹¶å®Œæˆ:", len(merged), "æ¡")
with open(MASTER,"w",encoding="utf-8") as f:
    f.write("\n".join(sorted(merged)))
EOF

      - name: Split 16 parts
        run: |
          python3 << 'EOF'
import os, math

MASTER="merged_rules.txt"
TMP="tmp"
os.makedirs(TMP,exist_ok=True)

lines=[l.strip() for l in open(MASTER,"r",encoding="utf-8") if l.strip()]
total=len(lines)
per=math.ceil(total/16)
print("æ€»è§„åˆ™:",total,"æ¯ç‰‡:",per)

for i in range(16):
    part=lines[i*per:(i+1)*per]
    fn=f"tmp/part_{i+1:02d}.txt"
    open(fn,"w",encoding="utf-8").write("\n".join(part))
    print("âœ… ç”Ÿæˆ",fn,"æ¡æ•°:",len(part))
EOF

      - id: set-matrix
        run: echo "matrix=$(printf '%s' $(jq -n '[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16]'))" >> $GITHUB_OUTPUT

  validate:
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        part: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          pip install dnspython

      - name: Validate DNS Part
        run: |
          python3 << 'EOF'
import dns.resolver, os, threading, concurrent.futures

part = "${{ matrix.part }}"
infile = f"tmp/part_{int(part):02d}.txt"
outfile = f"dist/validated_part_{part}.txt"
os.makedirs("dist",exist_ok=True)

if not os.path.exists(infile):
    print("âŒ ç¼ºå¤±åˆ†ç‰‡", infile)
    exit(1)

rules=[l.strip() for l in open(infile,"r",encoding="utf-8") if l.strip()]
print(f"â± åˆ†ç‰‡ {part}: {len(rules)} æ¡")

def check(rule):
    resolver = dns.resolver.Resolver()
    resolver.timeout = 2
    resolver.lifetime = 2
    domain = rule.lstrip("|").split("^")[0].replace("*","")
    if not domain: return None
    try:
        resolver.resolve(domain)
        return rule
    except:
        return None

valid=[]
with concurrent.futures.ThreadPoolExecutor(max_workers=50) as ex:
    total=len(rules)
    done=0
    futures={ex.submit(check,r):r for r in rules}
    for fut in concurrent.futures.as_completed(futures):
        done+=1
        r=fut.result()
        if r: valid.append(r)
        if done%500==0:
            print(f"âœ… åˆ†ç‰‡{part}: å·²éªŒè¯ {done}/{total}ï¼Œæœ‰æ•ˆ {len(valid)}")

open(outfile,"w",encoding="utf-8").write("\n".join(valid))
print(f"âœ… åˆ†ç‰‡ {part} å®Œæˆï¼Œæœ‰æ•ˆ {len(valid)} â†’ {outfile}")
EOF

      - name: Upload Result
        uses: actions/upload-artifact@v4
        with:
          name: validated_parts
          path: dist/validated_part_${{ matrix.part }}.txt

  merge:
    needs: validate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          name: validated_parts

      - name: Merge validated parts
        run: |
          mkdir -p dist
          cat dist/validated_part_*.txt | sort -u > dist/final_validated.txt
          echo "âœ… åˆå¹¶å®Œæˆ â†’ dist/final_validated.txt"
          echo "âœ… æœ€ç»ˆæœ‰æ•ˆè§„åˆ™æ•°:"
          wc -l dist/final_validated.txt

      - name: Push result
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions@github.com"
          git add dist/final_validated.txt
          git commit -m "Updated validated rules"
          git push || echo "âœ… æ— æ›´æ–°å¯æ¨é€"
