name: Split & DNS Check

on:
  schedule:
    - cron: "0 0 * * *"     # âœ… æ¯å¤©å¼ºåˆ¶æ›´æ–°ä¸‹è½½
    - cron: "0 6 * * *"
    - cron: "0 12 * * *"
    - cron: "0 18 * * *"
    - cron: "*/22 * * * *"  # âœ… æ¯ 22 åˆ†é’Ÿä»…éªŒè¯ï¼Œä¸ä¸‹è½½
  workflow_dispatch:
    inputs:
      part:
        description: 'æ‰‹åŠ¨éªŒè¯æŒ‡å®šåˆ†ç‰‡ 1~16'
        required: false
        default: "0"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ§© Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ›  é…ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.x"

    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        pip install dnspython requests

    - name: ğŸ•’ åˆ¤æ–­æ˜¯å¦å¼ºåˆ¶ä¸‹è½½
      id: check_time
      run: |
        CURRENT_HOUR=$(date -u +"%H")
        echo "â± å½“å‰ UTC å°æ—¶: $CURRENT_HOUR"
        
        # âœ… æ”¹åŠ¨å¤„ï¼šUTC 0/6/12/18 ç‚¹å¼ºåˆ¶ä¸‹è½½
        if [[ "$CURRENT_HOUR" == "00" || "$CURRENT_HOUR" == "06" || "$CURRENT_HOUR" == "12" || "$CURRENT_HOUR" == "18" ]]; then
            echo "force=yes" >> $GITHUB_OUTPUT
        else
            echo "force=no" >> $GITHUB_OUTPUT
        fi

    - name: ğŸ§ª æ‰§è¡ŒéªŒè¯è„šæœ¬
      run: |
        mkdir -p logs tmp dist

        PART="${{ github.event.inputs.part }}"
        FORCE="${{ steps.check_time.outputs.force }}"

        # âœ… æ”¹åŠ¨å¤„ï¼šåˆ¤æ–­æ˜¯å¦å¼ºåˆ¶ä¸‹è½½
        if [[ "$FORCE" == "yes" ]]; then
          echo "ğŸš€ å¼ºåˆ¶ä¸‹è½½å¹¶ç”Ÿæˆåˆ†ç‰‡"
          python3 split_and_check_16.py --force-download > logs/run.log 2>&1
        else
          if [[ "$PART" != "0" ]]; then
            echo "ğŸ” ä»…éªŒè¯åˆ†ç‰‡ï¼š$PART"
            python3 split_and_check_16.py --part $PART > logs/run.log 2>&1
          else
            echo "âœ… æ™®é€šè½®è®­éªŒè¯ï¼ˆä¸ä¸‹è½½ï¼‰"
            python3 split_and_check_16.py > logs/run.log 2>&1
          fi
        fi

        echo "ğŸ“‚ å½“å‰ tmp æ–‡ä»¶ï¼š"
        ls -lh tmp

    - name: ğŸ§¹ é˜²æ­¢ Git æœªæš‚å­˜å¯¼è‡´ pull å¤±è´¥
      run: |
        # âœ… æ”¹åŠ¨å¤„ï¼šåª add çœŸå®å­˜åœ¨çš„æ–‡ä»¶
        git add tmp/*.txt dist/*.txt || true
        git add dist/delete_counter.json || true

    - name: âœ… æäº¤ç»“æœ
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

        # âœ… æ— å˜åŒ–ä¸ç”¨æäº¤
        if git diff --cached --quiet; then
            echo "â„¹ æ— ä»»ä½•å˜åŒ–ï¼Œä¸éœ€è¦æäº¤"
            exit 0
        fi

        # âœ… æäº¤
        git commit -m "ğŸ¤– è‡ªåŠ¨éªŒè¯æ›´æ–°"

        # âœ… æ”¹åŠ¨å¤„ï¼šé¿å… rebase é”™è¯¯ï¼Œæ”¹ä¸º --no-rebase
        git pull --no-rebase || echo "âš  Pull å¤±è´¥ï¼Œç»§ç»­ Push"

        git push origin main
